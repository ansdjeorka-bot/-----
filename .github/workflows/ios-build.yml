name: iOS Build

# ìˆ˜ë™ íŠ¸ë¦¬ê±° ë˜ëŠ” push ì‹œ ì‹¤í–‰
on:
  workflow_dispatch:  # GitHubì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰ ê°€ëŠ¥
  push:
    branches: [ main, master ]

jobs:
  build-ios:
    runs-on: macos-latest  # macOSì—ì„œë§Œ iOS ë¹Œë“œ ê°€ëŠ¥
    
    steps:
    - name: Checkout ì½”ë“œ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'  # Node.js 20 ì‚¬ìš©
        cache: 'npm'
        
    - name: í”„ë¡œì íŠ¸ ì •ë³´ í™•ì¸
      run: |
        echo "Node.js ë²„ì „:"
        node --version
        echo "npm ë²„ì „:"
        npm --version
        echo "í˜„ì¬ ë””ë ‰í† ë¦¬:"
        pwd
        echo "íŒŒì¼ ëª©ë¡:"
        ls -la
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm install
      
    - name: ì›¹ ë¹Œë“œ
      run: npm run build
      
    - name: Capacitor ë²„ì „ í™•ì¸
      run: npx cap --version
      
    - name: Capacitor iOS í”Œë«í¼ ë™ê¸°í™”
      run: |
        if [ -d "ios" ]; then
          echo "iOS í´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ë™ê¸°í™”ë§Œ ì§„í–‰í•©ë‹ˆë‹¤."
          npx cap sync ios
        else
          echo "iOS í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ì¶”ê°€í•©ë‹ˆë‹¤."
          npx cap add ios
        fi
        
    - name: iOS í”„ë¡œì íŠ¸ ì •ë³´ í™•ì¸
      run: |
        if [ -d "ios" ]; then
          echo "iOS í´ë” ë‚´ìš©:"
          ls -la ios/
          if [ -d "ios/App" ]; then
            echo "iOS App í´ë” ë‚´ìš©:"
            ls -la ios/App/
          fi
        else
          echo "iOS í´ë”ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        fi

    # ğŸ¯ iOS ë¹Œë“œ ì‹œì‘ (ìë™ ì„œëª… ë°©ì‹)
    - name: iOS Bundle ID ì„¤ì •
      run: |
        cd ios/App
        # Bundle IDë¥¼ ê³ ìœ í•˜ê²Œ ì„¤ì • (GitHub ì‚¬ìš©ìëª… í¬í•¨)
        BUNDLE_ID="com.github.${{ github.repository_owner }}.visitapp"
        echo "Bundle ID: $BUNDLE_ID"
        
        # Info.plistì—ì„œ Bundle ID ì—…ë°ì´íŠ¸
        /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier $BUNDLE_ID" App/Info.plist
        
        # project.pbxprojì—ì„œ Bundle ID ì—…ë°ì´íŠ¸
        sed -i '' "s/com\.clientvisit\.manager/$BUNDLE_ID/g" App.xcodeproj/project.pbxproj
        
    - name: iOS ìë™ ì„œëª… ë¹Œë“œ (Archive)
      run: |
        cd ios/App
        echo "iOS ë¹Œë“œ ì‹œì‘..."
        
        xcodebuild clean archive \
          -workspace App.xcworkspace \
          -scheme App \
          -archivePath App.xcarchive \
          -configuration Release \
          -destination generic/platform=iOS \
          CODE_SIGN_STYLE=Automatic \
          DEVELOPMENT_TEAM="" \
          CODE_SIGN_IDENTITY="" \
          PROVISIONING_PROFILE="" \
          -allowProvisioningUpdates
          
    - name: IPA ë‚´ë³´ë‚´ê¸° (ê°œì„ ëœ ë°©ë²•)
      run: |
        cd ios/App
        echo "IPA ë‚´ë³´ë‚´ê¸° ì‹œì‘..."
        
        # ë” ê°„ë‹¨í•œ ExportOptions.plist ìƒì„±
        cat > ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>development</string>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>stripSwiftSymbols</key>
            <false/>
            <key>compileBitcode</key>
            <false/>
        </dict>
        </plist>
        EOF
        
        # Archiveì—ì„œ ì§ì ‘ IPA ì¶”ì¶œ ì‹œë„
        echo "ë°©ë²• 1: xcodebuild export ì‹œë„..."
        if xcodebuild -exportArchive \
          -archivePath App.xcarchive \
          -exportPath ./build \
          -exportOptionsPlist ExportOptions.plist \
          -allowProvisioningUpdates; then
          echo "âœ… xcodebuild export ì„±ê³µ"
        else
          echo "âŒ xcodebuild export ì‹¤íŒ¨, ëŒ€ì•ˆ ë°©ë²• ì‹œë„..."
          
          # ë°©ë²• 2: Archiveì—ì„œ ì§ì ‘ ì•± íŒŒì¼ ë³µì‚¬
          echo "ë°©ë²• 2: Archiveì—ì„œ ì§ì ‘ ì¶”ì¶œ..."
          mkdir -p ./build
          
          # Archive ë‚´ë¶€ êµ¬ì¡° í™•ì¸
          echo "Archive ë‚´ìš©:"
          find App.xcarchive -name "*.app" -type d
          
          # .app íŒŒì¼ì„ .ipaë¡œ ë³€í™˜
          APP_PATH=$(find App.xcarchive -name "*.app" -type d | head -1)
          if [ -n "$APP_PATH" ]; then
            echo "App íŒŒì¼ ë°œê²¬: $APP_PATH"
            
            # Payload í´ë” ìƒì„± ë° ì•± ë³µì‚¬
            mkdir -p ./build/Payload
            cp -r "$APP_PATH" ./build/Payload/
            
            # IPA íŒŒì¼ ìƒì„±
            cd ./build
            zip -r "App.ipa" Payload/
            cd ..
            
            echo "âœ… ìˆ˜ë™ IPA ìƒì„± ì™„ë£Œ"
            ls -la ./build/
          else
            echo "âŒ .app íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          fi
        fi
        
        # ìµœì¢… ê²°ê³¼ í™•ì¸
        echo "=== ìµœì¢… ë¹Œë“œ ê²°ê³¼ ==="
        find ./build -name "*.ipa" -exec ls -la {} \; || echo "IPA íŒŒì¼ ì—†ìŒ"
        
    - name: IPA íŒŒì¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: iOS-App
        path: ios/App/build/*.ipa
        retention-days: 7
        
    - name: ë¹Œë“œ ê²°ê³¼ í™•ì¸
      run: |
        echo "ğŸ‰ iOS ë¹Œë“œ ì™„ë£Œ!"
        echo "Artifactsì—ì„œ IPA íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        cd ios/App
        if ls ./build/*.ipa 1> /dev/null 2>&1; then
          echo "âœ… IPA íŒŒì¼ ìƒì„± ì„±ê³µ"
          ls -la ./build/
          echo "íŒŒì¼ í¬ê¸°:"
          du -h ./build/*.ipa
        else
          echo "âŒ IPA íŒŒì¼ ìƒì„± ì‹¤íŒ¨"
        fi
